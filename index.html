<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>AI 교육 도우미</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Segoe UI', Arial, sans-serif;
			background: linear-gradient(135deg, #e0e7ff 0%, #f5f7fa 100%);
			height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
		}
		.chat-container {
			background: #fff;
			box-shadow: 0 4px 24px rgba(0,0,0,0.08);
			border-radius: 16px;
			width: 400px;
			max-width: 90vw;
			padding: 32px 24px 16px 24px;
			display: flex;
			flex-direction: column;
			align-items: center;
		}
		.title {
			font-size: 1.3rem;
			font-weight: 600;
			margin-bottom: 18px;
			color: #3b3b3b;
			text-align: center;
		}
		.chat-box {
			width: 100%;
			min-height: 180px;
			max-height: 260px;
			overflow-y: auto;
			background: #f3f6fa;
			border-radius: 8px;
			margin-bottom: 18px;
			padding: 12px;
			box-sizing: border-box;
		}
		.message {
			margin-bottom: 12px;
			display: flex;
			flex-direction: column;
		}
		.user {
			align-self: flex-end;
			background: #dbeafe;
			color: #1e293b;
			border-radius: 12px 12px 0 12px;
			padding: 8px 14px;
			max-width: 80%;
			font-size: 1rem;
		}
		.ai {
			align-self: flex-start;
			background: #e0e7ff;
			color: #334155;
			border-radius: 12px 12px 12px 0;
			padding: 8px 14px;
			max-width: 80%;
			font-size: 1rem;
		}
		.input-area {
			width: 100%;
			display: flex;
			gap: 8px;
		}
		.input-area input {
			flex: 1;
			padding: 10px;
			border-radius: 8px;
			border: 1px solid #cbd5e1;
			font-size: 1rem;
			outline: none;
		}
		.input-area button {
			padding: 10px 18px;
			border-radius: 8px;
			border: none;
			background: #6366f1;
			color: #fff;
			font-size: 1rem;
			cursor: pointer;
			transition: background 0.2s;
		}
		.input-area button:hover {
			background: #4338ca;
		}
	</style>
</head>
<body>
	<div class="chat-container">
		<div class="title">무엇이 필요하신가요?</div>
				<div class="chat-history-list" id="chatHistoryList" style="width:100%;margin-bottom:10px;display:none;"></div>
		<div class="chat-box" id="chatBox">
			<!-- 메시지 출력 영역 -->
		</div>
		<form class="input-area" id="chatForm">
			<input type="text" id="userInput" placeholder="궁금한 점을 입력하세요..." autocomplete="off" required />
			<button type="submit">질문</button>
		</form>
		<div class="extra-questions" id="extraQuestions" style="width:100%;margin-top:10px;display:none;"></div>
	</div>
	<script>
// 세션 기반 대화 및 상태 관리
const chatBox = document.getElementById('chatBox');
const chatForm = document.getElementById('chatForm');
const userInput = document.getElementById('userInput');
const chatHistoryList = document.getElementById('chatHistoryList');
const extraQuestions = document.getElementById('extraQuestions');

let sessions = [];
let currentSession = {
    id: Date.now(),
    title: '',
    summary: '',
    timestamp: new Date(),
    chat: [],
    questions: [],
    answers: []
};
let lastQuestion = '';

const aiModels = [
    {name: 'ChatGPT', reply: q => `ChatGPT의 답변입니다: \n${q}에 대해 자세히 설명드릴 수 있습니다. 궁금하신 점을 구체적으로 말씀해주시면 더욱 정확한 답변을 드릴 수 있습니다.`},
    {name: 'Bard', reply: q => `Bard의 답변입니다: \n${q}에 대해 다양한 관점에서 설명드릴 수 있습니다. 추가로 궁금하신 점이 있으신가요?`},
    {name: 'Claude', reply: q => `Claude의 답변입니다: \n${q}에 대해 친절하게 안내해드릴 수 있습니다. 더 자세한 설명이 필요하시면 말씀해 주세요.`}
];

function getYoutubeLink(question) {
    const query = encodeURIComponent(question);
    return `https://www.youtube.com/results?search_query=${query}`;
}

function predictExtraQuestions(question, aiAnswer) {
    let suggestions = [];
    if ((question+aiAnswer).includes('함수')) {
        suggestions.push('함수의 그래프를 그려볼까요?');
        suggestions.push('함수의 실생활 예시를 더 들어드릴까요?');
    }
    if ((question+aiAnswer).includes('미분')) {
        suggestions.push('미분의 기하학적 의미를 설명해드릴까요?');
        suggestions.push('미분과 적분의 차이가 궁금하신가요?');
    }
    if (suggestions.length === 0) {
        suggestions.push('관련된 예시를 더 들어드릴까요?');
        suggestions.push('이와 비슷한 다른 개념이 궁금하신가요?');
    }
    return suggestions;
}

function addMessage(text, sender) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message';
    const bubble = document.createElement('div');
    bubble.className = sender;
    bubble.textContent = text;
    msgDiv.appendChild(bubble);
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    currentSession.chat.push({text, sender});
    if(sender === 'user') currentSession.questions.push(text);
    if(sender === 'ai') currentSession.answers.push(text);
}

function showExtraQuestions(question, aiAnswer) {
    extraQuestions.innerHTML = '';
    const preds = predictExtraQuestions(question, aiAnswer);
    preds.forEach(q => {
        const btn = document.createElement('button');
        btn.textContent = q;
        btn.style.marginRight = '8px';
        btn.style.marginBottom = '4px';
        btn.type = 'button';
        btn.onclick = () => {
            userInput.value = q;
            userInput.focus();
        };
        extraQuestions.appendChild(btn);
    });
    extraQuestions.style.display = 'block';
}

function hideExtraQuestions() {
    extraQuestions.style.display = 'none';
}

function saveCurrentSession() {
    if (currentSession.chat.length > 0) {
        currentSession.summary = generateSessionSummary(currentSession);
        currentSession.title = currentSession.questions[0] ? currentSession.questions[0].slice(0, 20) : '새로운 대화';
        currentSession.timestamp = new Date();
        sessions.unshift({...currentSession});
        updateHistoryList();
        currentSession = {
            id: Date.now(),
            title: '',
            summary: '',
            timestamp: new Date(),
            chat: [],
            questions: [],
            answers: []
        };
    }
}

function updateHistoryList() {
    if (sessions.length === 0) {
        chatHistoryList.style.display = 'none';
        return;
    }
    chatHistoryList.innerHTML = '<b>이전 대화 목록:</b><br>';
    sessions.forEach((s, idx) => {
        const btn = document.createElement('button');
        btn.textContent = `${s.title} (${formatTimestamp(s.timestamp)})`;
        btn.style.marginRight = '8px';
        btn.type = 'button';
        btn.onclick = () => {
            chatBox.innerHTML = '';
            s.chat.forEach(m => addMessage(m.text, m.sender));
            hideExtraQuestions();
            showSessionSummary(s);
        };
        chatHistoryList.appendChild(btn);
        const exportBtn = document.createElement('button');
        exportBtn.textContent = '내보내기';
        exportBtn.style.marginRight = '8px';
        exportBtn.type = 'button';
        exportBtn.onclick = () => exportSessionAsMarkdown(s);
        chatHistoryList.appendChild(exportBtn);
    });
    chatHistoryList.style.display = 'block';
}

function formatTimestamp(ts) {
    const d = new Date(ts);
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ${d.getHours()}:${d.getMinutes()}`;
}

function getAIResponses(question) {
    return aiModels.map(model => model.reply(question));
}

function generateSessionSummary(session) {
    let summary = `# 대화 요약 (FAQ/스터디 가이드)\n\n`;
    session.questions.forEach((q, i) => {
        summary += `**Q${i+1}.** ${q}\n`;
        if(session.answers[i]) summary += `**A${i+1}.** ${session.answers[i]}\n`;
    });
    return summary;
}

function showSessionSummary(session) {
    let summaryDiv = document.getElementById('sessionSummary');
    if (!summaryDiv) {
        summaryDiv = document.createElement('div');
        summaryDiv.id = 'sessionSummary';
        summaryDiv.style.background = '#f1f5f9';
        summaryDiv.style.borderRadius = '8px';
        summaryDiv.style.padding = '10px';
        summaryDiv.style.marginTop = '10px';
        summaryDiv.style.fontSize = '0.95rem';
        chatBox.parentNode.appendChild(summaryDiv);
    }
    summaryDiv.innerHTML = `<pre style='white-space:pre-wrap;'>${session.summary}</pre>`;
}

function exportSessionAsMarkdown(session) {
    const blob = new Blob([session.summary], {type: 'text/markdown'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${session.title || '대화요약'}.md`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 100);
}

chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const question = userInput.value.trim();
    if (!question) return;

    // 새로운 주제(질문이 바뀌면) 세션 저장
    if (currentSession.chat.length > 0 && question !== lastQuestion) {
        saveCurrentSession();
        chatBox.innerHTML = '';
        let summaryDiv = document.getElementById('sessionSummary');
        if(summaryDiv) summaryDiv.innerHTML = '';
    }

    addMessage(question, 'user');
    userInput.value = '';
    hideExtraQuestions();
    lastQuestion = question;

    setTimeout(() => {
        const aiReplies = getAIResponses(question);
        aiReplies.forEach(reply => addMessage(reply + '\n(존댓말로 안내드렸습니다.)', 'ai'));
        const yt = getYoutubeLink(question);
        addMessage('더 자세한 설명은 유튜브에서 확인하실 수 있습니다: ' + yt, 'ai');
        showExtraQuestions(question, aiReplies[0]);
    }, 700);
});

window.addEventListener('beforeunload', () => {
    saveCurrentSession();
});
	</script>
</body>
</html>
